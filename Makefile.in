CROSS_TOOL              ?= arm-none-eabi-

CC                      := $(CROSS_TOOL)gcc
LD                      := $(CROSS_TOOL)ld
OC                      := $(CROSS_TOOL)objcopy

ARCH                    ?= stm32f303

SCRIPT_DIR              := scripts
BUILD_DIR               ?= build

TARGET                  ?= omfk
TARGET_BINARY           := $(BUILD_DIR)/$(TARGET).bin
TARGET_MAP              := $(BUILD_DIR)/$(TARGET).map

SERIAL_COMMUNICATION    ?= minicom -o -D
SERIAL_DEVICE           ?= /dev/ttyACM0

FLASH_TOOL              := st-flash
FLASH_ADDR              ?= 0x8000000

ARCH_DIR                := arch/$(ARCH)
ARCH_INC_DIR            := $(ARCH_DIR)/inc

KERNEL_DIR              := kernel
KERNEL_INC_DIR          := $(KERNEL_DIR)/inc

COMMON_DIR              := common
COMMON_INC_DIR          := $(COMMON_DIR)/inc

ALL_DIR                 := $(ARCH_DIR) $(KERNEL_DIR) $(COMMON_DIR)

BUILD_SCRIPT            := $(SCRIPT_DIR)/build.sh
LD_SCRIPT               := $(SCRIPT_DIR)/ld/$(ARCH).ld

CC_FLAGS                := -mcpu=cortex-m4 -mthumb -g -ffreestanding \
                           -std=gnu99 -I $(KERNEL_INC_DIR) -I $(ARCH_INC_DIR) \
                           -I $(COMMON_INC_DIR)
LD_FLAGS                := -T $(LD_SCRIPT) --cref \
                           -Map $(TARGET_MAP) -nostartfiles -nostdlib

SRCS                    := $(shell find $(ALL_DIR) -name '*.c')
OBJS                    := $(foreach obj, $(shell find \
                           $(ALL_DIR) -name '*.c' \
                           | grep -o '[a-z+_]*\.c' \
                           | sed -e 's/.c/.o/g'), $(BUILD_DIR)/$(obj))
